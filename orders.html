<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesanan & Tiket - FSF SHOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #0a0a0a; color: white; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(26, 26, 26, 0.4); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.05); }
        .status-open { @apply bg-blue-500/10 text-blue-500 border-blue-500/20; }
        .status-process { @apply bg-yellow-500/10 text-yellow-500 border-yellow-500/20; }
        .status-closed { @apply bg-green-500/10 text-green-500 border-green-500/20; }
    </style>
</head>
<body class="pb-24">

    <nav class="p-6 flex items-center justify-between max-w-2xl mx-auto sticky top-0 bg-[#0a0a0a]/80 backdrop-blur-md z-50">
        <button onclick="window.location.href='dashboard.html'" class="text-gray-400">
            <i class="fa-solid fa-chevron-left"></i>
        </button>
        <h2 id="pageTitle" class="font-black uppercase tracking-widest text-[10px]">Daftar Pesanan</h2>
        <div class="w-4"></div>
    </nav>

    <main class="max-w-2xl mx-auto px-6">
        <div class="flex gap-2 mb-8 overflow-x-auto no-scrollbar">
            <button class="px-5 py-2 glass rounded-2xl text-[10px] font-black border-blue-500/50 bg-blue-600/10">SEMUA</button>
            <button class="px-5 py-2 glass rounded-2xl text-[10px] font-black text-gray-500">PROSES</button>
            <button class="px-5 py-2 glass rounded-2xl text-[10px] font-black text-gray-500">SELESAI</button>
        </div>

        <div id="ordersList" class="space-y-4">
            <div class="animate-pulse glass h-24 rounded-3xl"></div>
            <div class="animate-pulse glass h-24 rounded-3xl"></div>
        </div>
    </main>

    <div class="fixed bottom-5 left-1/2 -translate-x-1/2 w-[90%] max-w-md glass rounded-[2rem] p-4 flex justify-around items-center z-50">
        <button onclick="window.location.href='dashboard.html'" class="text-gray-500 flex flex-col items-center gap-1">
            <i class="fa-solid fa-house text-lg"></i>
            <span class="text-[8px] font-bold uppercase">Home</span>
        </button>
        <button class="text-blue-500 flex flex-col items-center gap-1">
            <i class="fa-solid fa-receipt text-lg"></i>
            <span class="text-[8px] font-bold uppercase">Orders</span>
        </button>
        <button onclick="window.location.href='profile.html'" class="text-gray-500 flex flex-col items-center gap-1">
            <i class="fa-solid fa-gear text-lg"></i>
            <span class="text-[8px] font-bold uppercase">Settings</span>
        </button>
    </div>

    <script type="module">
        import { auth, db, supabase, formatRupiah } from './js/config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // 1. Cek Role User di Firestore
                const userSnap = await getDoc(doc(db, "users", user.uid));
                const role = userSnap.exists() ? userSnap.data().role : "BUYER";
                
                loadOrders(user.uid, role);
            } else { window.location.href = "index.html"; }
        });

        async function loadOrders(uid, role) {
            const list = document.getElementById('ordersList');
            let query = supabase.from('tickets').select('*').order('created_at', { ascending: false });

            // LOGIKA FILTER: Kalau bukan staff, cuma liat punya sendiri
            if (role === "BUYER" || !role) {
                query = query.eq('buyer_id', uid);
                document.getElementById('pageTitle').innerText = "Pesanan Saya";
            } else {
                document.getElementById('pageTitle').innerText = "Manajemen Tiket (" + role + ")";
            }

            const { data: tickets, error } = await query;

            if (error || tickets.length === 0) {
                list.innerHTML = `<div class="text-center py-20 opacity-30 italic text-xs">Belum ada tiket masuk...</div>`;
                return;
            }

            list.innerHTML = tickets.map(t => `
                <div class="glass p-5 rounded-[2rem] border border-white/5 flex justify-between items-center hover:border-blue-500/30 transition-all cursor-pointer"
                     onclick="window.location.href='ticket.html?id=${t.id}'">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl bg-blue-600/10 flex items-center justify-center text-blue-500 shadow-inner">
                            <i class="fa-solid fa-ticket"></i>
                        </div>
                        <div>
                            <h4 class="text-sm font-black text-white">${t.product_name}</h4>
                            <p class="text-[10px] text-gray-500 font-mono">${t.buyer_name} â€¢ ${formatRupiah(t.price)}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="px-3 py-1 rounded-full text-[8px] font-black uppercase border ${getStatusClass(t.status)}">
                            ${t.status}
                        </span>
                        <p class="text-[8px] text-gray-700 mt-2 font-bold">${new Date(t.created_at).toLocaleDateString()}</p>
                    </div>
                </div>
            `).join('');
        }

        function getStatusClass(status) {
            if(status === 'OPEN') return 'status-open';
            if(status === 'PROCESS') return 'status-process';
            if(status === 'CLOSED') return 'status-closed';
            return 'border-gray-800 text-gray-500';
        }
    </script>
</body>
</html>
