<!DOCTYPE html>
<html>
<head>
    <title>Klaim Garansi</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-black text-white min-h-screen p-6 font-mono">

    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8 border-b border-purple-600 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-purple-500">PUSAT GARANSI</h1>
                <p class="text-xs text-gray-400">Khusus Rebuyer & Member Terverifikasi</p>
            </div>
            <a href="market.html" class="bg-gray-800 px-4 py-2 rounded text-sm hover:bg-white hover:text-black">Kembali</a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <div class="md:col-span-2 space-y-4">
                <h3 class="font-bold text-white mb-2">Pilih Produk untuk Klaim:</h3>
                <div id="purchased-list" class="space-y-3">
                    <p class="text-center py-10 text-gray-500">Memuat riwayat pembelian...</p>
                </div>
            </div>

            <div class="glass p-6 border border-purple-900 rounded h-fit">
                <h3 class="font-bold text-purple-400 mb-4"><i class="fa-solid fa-scale-balanced"></i> SYARAT KLAIM</h3>
                <ul class="text-xs text-gray-300 space-y-3 list-disc pl-4">
                    <li>Wajib menyertakan <b>Bukti Screenshot</b> percakapan saat pembelian awal.</li>
                    <li>Garansi hanya berlaku untuk <b>cacat sistem</b> atau kesalahan seller.</li>
                    <li>Human error (kesalahan pengguna) membatalkan garansi.</li>
                    <li>Masa berlaku garansi sesuai deskripsi produk (Default: 7 Hari).</li>
                    <li>Dilarang spamming saat tiket klaim dibuat.</li>
                </ul>
                <div class="mt-6 p-3 bg-red-900/30 border border-red-500/50 rounded text-center">
                    <p class="text-[10px] text-red-300">"Saya telah membaca dan memiliki bukti Screenshot."</p>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { db, auth } from './app.js';
        import { collection, query, where, getDocs, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        auth.onAuthStateChanged(async (user) => {
            if(!user) return location.href = 'index.html';

            // 1. Cek Status Rebuyer
            const userSnap = await getDoc(doc(db, "users", user.uid));
            if(!userSnap.exists() || !userSnap.data().isRebuyer) {
                alert("Akses Ditolak: Anda belum memiliki status REBUYER (Belum ada transaksi lunas).");
                return location.href = 'market.html';
            }

            // 2. Ambil Tiket yang STATUSNYA 'CLOSED_PAID' (Lunas)
            const q = query(collection(db, "tickets"), 
                where("buyerUid", "==", user.uid), 
                where("status", "==", "CLOSED_PAID")
            );

            const snap = await getDocs(q);
            const list = document.getElementById('purchased-list');
            list.innerHTML = '';

            if(snap.empty) {
                list.innerHTML = '<div class="p-4 bg-gray-900 text-center text-gray-500">Belum ada produk yang lunas/garansi aktif.</div>';
                return;
            }

            snap.forEach(d => {
                const t = d.data();
                // Hitung sisa hari garansi (misal 7 hari dari lastMessage)
                // Logic sederhana: Tampilkan tombol claim
                list.innerHTML += `
                    <div class="bg-gray-900 p-4 rounded border border-gray-700 flex justify-between items-center hover:border-purple-500 transition">
                        <div>
                            <h4 class="font-bold text-white text-lg">${t.productName}</h4>
                            <p class="text-xs text-gray-400">Store: ${t.storeName} | ID: ${d.id}</p>
                            <p class="text-[10px] text-green-400 mt-1">STATUS: LUNAS (Garansi Aktif)</p>
                        </div>
                        <button onclick="claimWarranty('${d.id}', '${t.productId}', '${t.productName}', '${t.sellerUid}', '${t.storeName}')" 
                            class="bg-purple-600 hover:bg-white hover:text-purple-900 text-white font-bold px-4 py-2 rounded text-sm transition shadow-[0_0_15px_rgba(147,51,234,0.3)]">
                            KLAIM GARANSI
                        </button>
                    </div>
                `;
            });
        });

        window.claimWarranty = async (originTicketId, pid, pname, sellerUid, sname) => {
            const reason = prompt("Masukkan alasan klaim garansi secara singkat:");
            if(!reason) return;

            try {
                // Buat Tiket Tipe 'WARRANTY'
                const tRef = await addDoc(collection(db, "tickets"), {
                    type: 'WARRANTY',
                    originTicketId: originTicketId, // Referensi tiket lama
                    productId: pid,
                    productName: "[CLAIM] " + pname,
                    buyerUid: auth.currentUser.uid,
                    buyerName: auth.currentUser.displayName,
                    sellerUid: sellerUid,
                    storeName: sname,
                    status: 'OPEN',
                    createdAt: serverTimestamp(),
                    lastMessage: serverTimestamp()
                });

                // Kirim Pesan Otomatis
                await addDoc(collection(db, "tickets", tRef.id, "messages"), {
                    text: `PEGANGJUAN KLAIM GARANSI.\n\nAlasan: ${reason}\n\nUser wajib mengirimkan Screenshot bukti pembelian dari tiket sebelumnya.`,
                    senderUid: 'system',
                    senderName: 'SYSTEM WARRANTY',
                    createdAt: serverTimestamp()
                });

                window.location.href = `ticket.html?id=${tRef.id}`;
            } catch (e) {
                alert("Gagal: " + e.message);
            }
        }
    </script>
</body>
</html>
